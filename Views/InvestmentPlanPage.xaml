<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:local="clr-namespace:Tokero.ViewModels"
             xmlns:converters="clr-namespace:Tokero.Converters"
             xmlns:model="clr-namespace:Tokero.Models"
             x:Class="Tokero.Views.InvestmentPlanPage"
             x:Name="InvestmentPage"
             Title="Create Investment Plan">
    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:IntEnumConverter x:Key="IntEnum" />
            <converters:BoolToCheckConverter x:Key="BoolToCheckConverter" />
            <converters:CountToBoolConverter x:Key="CountToBoolConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>
    <ScrollView>
        <Grid x:Name="MainGrid"
              Margin="20"
              RowSpacing="20"
              ColumnSpacing="20">
            <VisualStateManager.VisualStateGroups>
                <VisualStateGroup x:Name="WindowStates">
                    <VisualState x:Name="Narrow">
                        <VisualState.StateTriggers>
                            <AdaptiveTrigger MinWindowWidth="0" />
                        </VisualState.StateTriggers>
                        <VisualState.Setters>
                            <Setter TargetName="MainGrid"
                                    Property="ColumnDefinitions"
                                    Value="*" />
                            <Setter TargetName="MainGrid"
                                    Property="RowDefinitions"
                                    Value="Auto, Auto, Auto" />
                            <Setter TargetName="PrimaryInfoPanel"
                                    Property="Grid.Row"
                                    Value="0" />
                            <Setter TargetName="PrimaryInfoPanel"
                                    Property="Grid.Column"
                                    Value="0" />
                            <Setter TargetName="ConfigurationPanel"
                                    Property="Grid.Row"
                                    Value="1" />
                            <Setter TargetName="ConfigurationPanel"
                                    Property="Grid.Column"
                                    Value="0" />
                            <Setter TargetName="ActionButtonsPanel"
                                    Property="Grid.Row"
                                    Value="2" />
                            <Setter TargetName="ActionButtonsPanel"
                                    Property="Grid.Column"
                                    Value="0" />
                        </VisualState.Setters>
                    </VisualState>
                    <VisualState x:Name="Wide">
                        <VisualState.StateTriggers>
                            <AdaptiveTrigger MinWindowWidth="800" />
                        </VisualState.StateTriggers>
                        <VisualState.Setters>
                            <Setter TargetName="MainGrid"
                                    Property="ColumnDefinitions"
                                    Value="*,*" />
                            <Setter TargetName="MainGrid"
                                    Property="RowDefinitions"
                                    Value="*, Auto" />
                            <Setter TargetName="PrimaryInfoPanel"
                                    Property="Grid.Row"
                                    Value="0" />
                            <Setter TargetName="PrimaryInfoPanel"
                                    Property="Grid.Column"
                                    Value="0" />
                            <Setter TargetName="ConfigurationPanel"
                                    Property="Grid.Row"
                                    Value="0" />
                            <Setter TargetName="ConfigurationPanel"
                                    Property="Grid.Column"
                                    Value="1" />
                            <Setter TargetName="ActionButtonsPanel"
                                    Property="Grid.Row"
                                    Value="1" />
                            <Setter TargetName="ActionButtonsPanel"
                                    Property="Grid.Column"
                                    Value="0" />
                            <Setter TargetName="ActionButtonsPanel"
                                    Property="Grid.ColumnSpan"
                                    Value="2" />
                        </VisualState.Setters>
                    </VisualState>
                </VisualStateGroup>
            </VisualStateManager.VisualStateGroups>
            <StackLayout x:Name="PrimaryInfoPanel"
                         Spacing="10">
                <Label Text="Plan Name"
                       FontSize="16"
                       FontAttributes="Bold" />
                <Entry Placeholder="e.g., My Long-Term Crypto Plan"
                       Text="{Binding PlanName}" />

                <Label Text="Default Investment Details"
                       FontSize="22"
                       FontAttributes="Bold"
                       Margin="0,20,0,0" />
                <Label Text="These values are used for newly selected cryptocurrencies."
                       FontSize="12"
                       TextColor="Gray" />

                <Label Text="Start Date"
                       FontSize="16"
                       Margin="0,10,0,5" />
                <DatePicker Date="{Binding StartDate}" />
                <Label Text="Total Monthly Investment (for Equal Distribution)"
                       FontSize="16"
                       Margin="0,10,0,5" />
                <Entry Placeholder="Enter total amount (€)"
                       Text="{Binding InvestmentAmount}"
                       Keyboard="Numeric" />

                <Label Text="Select Cryptocurrencies"
                       FontSize="22"
                       FontAttributes="Bold"
                       Margin="0,20,0,10" />
                <CollectionView ItemsSource="{Binding AvailableCryptos}"
                                SelectionMode="Multiple">
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="model:CryptoCurrency">
                            <Grid Padding="10">
                                <Grid.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding Source={x:Reference InvestmentPage}, Path=BindingContext.ToggleSelectionCommand}"
                                                          CommandParameter="{Binding .}">
                                    </TapGestureRecognizer>
                                </Grid.GestureRecognizers>
                                <Grid.Triggers>
                                    <DataTrigger TargetType="Grid"
                                                 Binding="{Binding IsSelected}"
                                                 Value="True">
                                        <Setter Property="BackgroundColor"
                                                Value="{AppThemeBinding Light=#ADD8E6, Dark=#003366}" />
                                    </DataTrigger>
                                </Grid.Triggers>
                                <HorizontalStackLayout Spacing="10">
                                    <Label Text="{Binding Name}"
                                           VerticalOptions="Center" />
                                    <Label Text="{Binding IsSelected, Converter={StaticResource BoolToCheckConverter}}"
                                           TextColor="Green"
                                           FontSize="Large"
                                           VerticalOptions="Center" />
                                </HorizontalStackLayout>
                            </Grid>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
            </StackLayout>
            <StackLayout x:Name="ConfigurationPanel"
                         Spacing="10">
                <Label Text="Configure Your Assets"
                       FontSize="22"
                       FontAttributes="Bold"
                       IsVisible="{Binding ConfiguredAssets.Count, Converter={StaticResource CountToBoolConverter}}" />
                <Picker Title="Allocation Strategy"
                        ItemsSource="{Binding AllocationStrategies}"
                        SelectedIndex="{Binding SelectedAllocationStrategy, Converter={StaticResource IntEnum}}"
                        IsVisible="{Binding ConfiguredAssets.Count, Converter={StaticResource CountToBoolConverter}}" />
                <CollectionView ItemsSource="{Binding ConfiguredAssets}">
                    <CollectionView.ItemTemplate>
                        <DataTemplate>
                            <Frame Padding="10"
                                   Margin="0,5"
                                   CornerRadius="5">
                                <StackLayout>
                                    <Label Text="{Binding Name}"
                                           FontSize="18"
                                           FontAttributes="Bold" />
                                    <Label Text="Monthly Amount (€)"
                                           FontSize="14"
                                           Margin="0,10,0,0" />
                                    <Entry Text="{Binding MonthlyInvestment}"
                                           Keyboard="Numeric">
                                        <Entry.Triggers>
                                            <DataTrigger TargetType="Entry"
                                                         Binding="{Binding Source={x:Reference InvestmentPage}, Path=BindingContext.SelectedAllocationStrategy}"
                                                         Value="EqualDistribution">
                                                <Setter Property="IsEnabled"
                                                        Value="False" />
                                            </DataTrigger>
                                        </Entry.Triggers>
                                    </Entry>
                                    <Label Text="Start Date"
                                           FontSize="14"
                                           Margin="0,10,0,0" />
                                    <DatePicker Date="{Binding StartDate}" />
                                </StackLayout>
                            </Frame>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
            </StackLayout>
            <StackLayout x:Name="ActionButtonsPanel"
                         Spacing="10"
                         Margin="0,20,0,0">
                <Button Text="Create Plan"
                        Command="{Binding CreatePlanCommand}"
                        Style="{StaticResource PrimaryButtonStyle}"/>
                <Button Text="Cancel"
                        Command="{Binding CancelCommand}"
                        Style="{StaticResource SecondaryButtonStyle}" />
            </StackLayout>

        </Grid>
    </ScrollView>
</ContentPage>
